{% extends "base.html" %}

{% block title %}{{ table_name }} - AI News Admin{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2">
                        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item active">{{ table_name }}</li>
                    </ol>
                </nav>
                <h2>
                    <i class="fas fa-table me-2"></i>{{ table_name }}
                    <span class="badge bg-secondary">{{ total_count }} records</span>
                </h2>
            </div>
            <div>
                <button class="btn btn-success me-2" onclick="addRecord()">
                    <i class="fas fa-plus me-2"></i>Add Record
                </button>
                <button class="btn btn-outline-primary" onclick="refreshTable()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
            </div>
        </div>

        <!-- Table Actions -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-success btn-sm" onclick="downloadTable()">
                                <i class="fas fa-download me-1"></i>Download CSV
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="uploadData()">
                                <i class="fas fa-upload me-1"></i>Upload CSV
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteSelected()">
                                <i class="fas fa-trash me-1"></i>Delete Selected
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="d-flex justify-content-end align-items-center gap-2">
                            <label class="form-label mb-0">Per page:</label>
                            <select class="form-select form-select-sm" style="width: auto;" onchange="changePerPage(this.value)">
                                <option value="25" {{ 'selected' if per_page == 25 else '' }}>25</option>
                                <option value="50" {{ 'selected' if per_page == 50 else '' }}>50</option>
                                <option value="100" {{ 'selected' if per_page == 100 else '' }}>100</option>
                                <option value="500" {{ 'selected' if per_page == 500 else '' }}>500</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="dataTable">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th width="40">
                                    <input type="checkbox" class="form-check-input" id="selectAll">
                                </th>
                                <th width="60">Actions</th>
                                {% for column in structure %}
                                <th>
                                    {{ column.column_name }}
                                    <small class="text-muted d-block">{{ column.data_type }}</small>
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input row-select" value="{{ row.get(structure[0].column_name) if structure else '' }}">
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="editRecord('{{ row.get(structure[0].column_name) if structure else '' }}')">
                                                <i class="fas fa-edit me-2"></i>Edit</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="viewRecord('{{ row.get(structure[0].column_name) if structure else '' }}')">
                                                <i class="fas fa-eye me-2"></i>View</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteRecord('{{ row.get(structure[0].column_name) if structure else '' }}')">
                                                <i class="fas fa-trash me-2"></i>Delete</a></li>
                                        </ul>
                                    </div>
                                </td>
                                {% for column in structure %}
                                <td>
                                    {% set value = row.get(column.column_name) %}
                                    {% if value is none %}
                                        <span class="text-muted fst-italic">NULL</span>
                                    {% elif column.data_type == 'text' and value|length > 100 %}
                                        <span title="{{ value }}">{{ value[:100] }}...</span>
                                    {% elif column.data_type in ['timestamp', 'timestamptz'] %}
                                        <small>{{ value.strftime('%Y-%m-%d %H:%M') if value else '' }}</small>
                                    {% elif column.data_type == 'boolean' %}
                                        <span class="badge bg-{{ 'success' if value else 'secondary' }}">
                                            {{ 'Yes' if value else 'No' }}
                                        </span>
                                    {% elif column.data_type in ['integer', 'bigint'] %}
                                        <code>{{ value }}</code>
                                    {% else %}
                                        {{ value }}
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                <!-- Previous -->
                <li class="page-item {{ 'disabled' if page == 1 else '' }}">
                    <a class="page-link" href="?page={{ page - 1 }}&per_page={{ per_page }}">Previous</a>
                </li>
                
                <!-- Page Numbers -->
                {% set start_page = [page - 2, 1]|max %}
                {% set end_page = [page + 2, total_pages]|min %}
                
                {% if start_page > 1 %}
                    <li class="page-item"><a class="page-link" href="?page=1&per_page={{ per_page }}">1</a></li>
                    {% if start_page > 2 %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endif %}
                
                {% for p in range(start_page, end_page + 1) %}
                    <li class="page-item {{ 'active' if p == page else '' }}">
                        <a class="page-link" href="?page={{ p }}&per_page={{ per_page }}">{{ p }}</a>
                    </li>
                {% endfor %}
                
                {% if end_page < total_pages %}
                    {% if end_page < total_pages - 1 %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                    <li class="page-item"><a class="page-link" href="?page={{ total_pages }}&per_page={{ per_page }}">{{ total_pages }}</a></li>
                {% endif %}
                
                <!-- Next -->
                <li class="page-item {{ 'disabled' if page == total_pages else '' }}">
                    <a class="page-link" href="?page={{ page + 1 }}&per_page={{ per_page }}">Next</a>
                </li>
            </ul>
        </nav>
        
        <div class="text-center text-muted">
            Showing {{ ((page - 1) * per_page + 1) }} to {{ [page * per_page, total_count]|min }} of {{ total_count }} records
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit Record Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Record
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div id="editFields"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRecord()">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
const tableName = '{{ table_name }}';
const tableStructure = {{ structure | tojsonfilter }};

// Select all functionality
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.row-select');
    checkboxes.forEach(cb => cb.checked = this.checked);
});

function refreshTable() {
    location.reload();
}

function changePerPage(perPage) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', perPage);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

async function addRecord() {
    // Get enhanced table structure with foreign key information
    try {
        const response = await fetch(`/api/table_structure/${tableName}`);
        const data = await response.json();
        
        if (data.success) {
            const enhancedStructure = data.structure;
            
            // Create form for adding new record
            let fieldsHtml = '<div class="row">';
            enhancedStructure.forEach((column, index) => {
                if (column.column_name !== 'id' && column.column_name !== 'created_at' && column.column_name !== 'updated_at') {
                    
                    if (column.has_foreign_key && column.foreign_key_options) {
                        // Create dropdown for foreign key fields
                        let optionsHtml = '<option value="">-- Select --</option>';
                        column.foreign_key_options.forEach(option => {
                            // Handle different foreign key reference formats
                            let value, display;
                            if (option.id !== undefined) {
                                value = option.id;
                                display = option.category ? `${option.category} - ${option.description}` : option.id;
                            } else if (option.category !== undefined) {
                                value = option.category;
                                display = option.category;
                            } else {
                                value = Object.values(option)[0];
                                display = Object.values(option).join(' - ');
                            }
                            optionsHtml += `<option value="${value}">${display}</option>`;
                        });
                        
                        fieldsHtml += `
                            <div class="col-md-6 mb-3">
                                <label class="form-label">${column.column_name} <span class="badge bg-info">Foreign Key</span></label>
                                <select class="form-select" name="${column.column_name}" ${column.is_nullable === 'NO' ? 'required' : ''}>
                                    ${optionsHtml}
                                </select>
                                <small class="form-text text-muted">References ${column.column_name === 'ai_topics_id' ? 'ai_topics.id' : 'ai_topics.category'} ${column.is_nullable === 'NO' ? '(Required)' : '(Optional)'}</small>
                            </div>
                        `;
                    } else {
                        // Regular input field
                        let inputType = 'text';
                        if (column.data_type.includes('boolean')) {
                            inputType = 'checkbox';
                        } else if (column.data_type.includes('integer') || column.data_type.includes('bigint')) {
                            inputType = 'number';
                        } else if (column.data_type.includes('date') || column.data_type.includes('timestamp')) {
                            inputType = 'datetime-local';
                        }
                        
                        fieldsHtml += `
                            <div class="col-md-6 mb-3">
                                <label class="form-label">${column.column_name}</label>
                                <input type="${inputType}" class="form-control" name="${column.column_name}" 
                                       placeholder="${column.data_type}" ${column.is_nullable === 'NO' ? 'required' : ''}>
                                <small class="form-text text-muted">${column.data_type} ${column.is_nullable === 'NO' ? '(Required)' : '(Optional)'}</small>
                            </div>
                        `;
                    }
                }
            });
            fieldsHtml += '</div>';
            
            document.getElementById('editFields').innerHTML = fieldsHtml;
            document.querySelector('#editModal .modal-title').innerHTML = '<i class="fas fa-plus me-2"></i>Add New Record';
            document.getElementById('editModal').setAttribute('data-mode', 'add');
            
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        } else {
            alert('Failed to load table structure: ' + data.message);
        }
    } catch (error) {
        console.error('Error loading table structure:', error);
        alert('Error loading form. Please try again.');
    }
}

async function editRecord(id) {
    try {
        // Get record data and enhanced table structure
        const [recordResponse, structureResponse] = await Promise.all([
            fetch(`/api/record/${tableName}/${id}`),
            fetch(`/api/table_structure/${tableName}`)
        ]);
        
        const recordData = await recordResponse.json();
        const structureData = await structureResponse.json();
        
        if (recordData.success && structureData.success) {
            const record = recordData.record;
            const enhancedStructure = structureData.structure;
            
            // Create form for editing record
            let fieldsHtml = '<div class="row">';
            enhancedStructure.forEach((column, index) => {
                if (column.column_name !== 'created_at' && column.column_name !== 'updated_at') {
                    const fieldValue = record[column.column_name] || '';
                    const isIdField = column.column_name === 'id';
                    
                    if (column.has_foreign_key && column.foreign_key_options && !isIdField) {
                        // Create dropdown for foreign key fields
                        let optionsHtml = '<option value="">-- Select --</option>';
                        column.foreign_key_options.forEach(option => {
                            // Handle different foreign key reference formats
                            let value, display, isSelected = false;
                            if (option.id !== undefined) {
                                value = option.id;
                                display = option.category ? `${option.category} - ${option.description}` : option.id;
                                isSelected = fieldValue == value;
                            } else if (option.category !== undefined) {
                                value = option.category;
                                display = option.category;
                                isSelected = fieldValue == value;
                            } else {
                                value = Object.values(option)[0];
                                display = Object.values(option).join(' - ');
                                isSelected = fieldValue == value;
                            }
                            optionsHtml += `<option value="${value}" ${isSelected ? 'selected' : ''}>${display}</option>`;
                        });
                        
                        fieldsHtml += `
                            <div class="col-md-6 mb-3">
                                <label class="form-label">${column.column_name} <span class="badge bg-info">Foreign Key</span></label>
                                <select class="form-select" name="${column.column_name}" ${column.is_nullable === 'NO' ? 'required' : ''}>
                                    ${optionsHtml}
                                </select>
                                <small class="form-text text-muted">References ${column.column_name === 'ai_topics_id' ? 'ai_topics.id' : 'ai_topics.category'} ${column.is_nullable === 'NO' ? '(Required)' : '(Optional)'}</small>
                            </div>
                        `;
                    } else {
                        // Regular input field
                        let inputType = 'text';
                        let inputValue = fieldValue;
                        
                        if (column.data_type.includes('boolean')) {
                            inputType = 'checkbox';
                            inputValue = fieldValue ? 'checked' : '';
                        } else if (column.data_type.includes('integer') || column.data_type.includes('bigint')) {
                            inputType = 'number';
                        } else if (column.data_type.includes('date') || column.data_type.includes('timestamp')) {
                            inputType = 'datetime-local';
                            if (inputValue && typeof inputValue === 'string') {
                                inputValue = inputValue.replace('Z', '').substring(0, 16);
                            }
                        }
                        
                        fieldsHtml += `
                            <div class="col-md-6 mb-3">
                                <label class="form-label">${column.column_name} ${isIdField ? '<span class="badge bg-secondary">ID</span>' : ''}</label>
                                <input type="${inputType}" class="form-control" name="${column.column_name}" 
                                       value="${inputValue}" ${isIdField ? 'readonly' : ''} 
                                       ${column.is_nullable === 'NO' ? 'required' : ''} ${inputType === 'checkbox' ? inputValue : ''}>
                                <small class="form-text text-muted">${column.data_type} ${isIdField ? '(Read-only)' : column.is_nullable === 'NO' ? '(Required)' : '(Optional)'}</small>
                            </div>
                        `;
                    }
                }
            });
            fieldsHtml += '</div>';
            
            document.getElementById('editFields').innerHTML = fieldsHtml;
            document.querySelector('#editModal .modal-title').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Record';
            document.getElementById('editModal').setAttribute('data-mode', 'edit');
            document.getElementById('editModal').setAttribute('data-record-id', id);
            
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        } else {
            alert('Failed to load record data: ' + (recordData.message || structureData.message));
        }
    } catch (error) {
        console.error('Error loading record:', error);
        alert('Error loading record. Please try again.');
    }
}

function viewRecord(id) {
    // This would show a detailed view of the record
    alert('View functionality coming soon!');
}

async function deleteRecord(id) {
    if (confirm('Are you sure you want to delete this record?')) {
        try {
            const response = await fetch(`/api/record/${tableName}/${id}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Record deleted successfully');
                location.reload();
            } else {
                alert('Delete failed: ' + result.message);
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('Error deleting record. Please try again.');
        }
    }
}

async function deleteSelected() {
    const selected = Array.from(document.querySelectorAll('.row-select:checked')).map(cb => cb.value);
    if (selected.length === 0) {
        alert('Please select records to delete');
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${selected.length} selected records?`)) {
        try {
            const response = await fetch(`/api/records/${tableName}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    record_ids: selected
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(`Successfully deleted ${result.rows_affected} records`);
                location.reload();
            } else {
                alert('Bulk delete failed: ' + result.message);
            }
        } catch (error) {
            console.error('Bulk delete error:', error);
            alert('Error deleting records. Please try again.');
        }
    }
}

async function saveRecord() {
    const form = document.getElementById('editForm');
    const formData = new FormData(form);
    const mode = document.getElementById('editModal').getAttribute('data-mode');
    const recordId = document.getElementById('editModal').getAttribute('data-record-id');
    
    // Convert FormData to object
    const data = {};
    for (let [key, value] of formData.entries()) {
        // Handle checkbox values
        if (form.querySelector(`[name="${key}"][type="checkbox"]`)) {
            data[key] = form.querySelector(`[name="${key}"]`).checked;
        } else {
            // Convert empty strings to null for optional fields
            data[key] = value === '' ? null : value;
        }
    }
    
    try {
        let url, method;
        
        if (mode === 'add') {
            url = `/api/record/${tableName}`;
            method = 'POST';
        } else {
            url = `/api/record/${tableName}/${recordId}`;
            method = 'PUT';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`Record ${mode === 'add' ? 'added' : 'updated'} successfully`);
            
            // Close modal and refresh table
            const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            modal.hide();
            location.reload();
        } else {
            alert(`${mode === 'add' ? 'Add' : 'Update'} failed: ` + result.message);
        }
    } catch (error) {
        console.error('Save error:', error);
        alert('Error saving record. Please try again.');
    }
}

function downloadTable() {
    window.open(`/download_table/${tableName}`, '_blank');
}

function uploadData() {
    alert('Upload functionality coming soon!');
}
</script>
{% endblock %}